<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV é»æ­Œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; text-align: center; }
        .card { background: #1e1e1e; padding: 30px 20px; border-radius: 20px; }
        input { width: 90%; padding: 15px; margin: 15px 0; border: none; border-radius: 10px; background: #333; color: white; font-size: 18px; }
        .send-btn { width: 95%; padding: 18px; border-radius: 10px; border: none; font-size: 20px; font-weight: bold; background: #00c853; color: white; margin-top: 10px; }
        p { color: #888; font-size: 14px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¤ é»æ­Œé™æ§å™¨</h2>
        <input type="text" id="songTitle" placeholder="é¸å¡«ï¼šä½ æƒ³é¡¯ç¤ºçš„æ­Œå">
        <input type="text" id="ytId" placeholder="å¿…å¡«ï¼šåœ¨æ­¤è²¼ä¸Š YouTube ç¶²å€">
        <button class="send-btn" onclick="sendSong()">âœ… ç¢ºèªé»æ­Œ</button>
        <p>è²¼ä¸Šç¶²å€å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¾¨è­˜å½±ç‰‡è³‡è¨Š</p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7FxIh0oUu21zTLxnhOttyN_kL0LiYAPw",
            authDomain: "my-karaoke-5b9e3.firebaseapp.com",
            databaseURL: "https://my-karaoke-5b9e3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-karaoke-5b9e3",
            storageBucket: "my-karaoke-5b9e3.firebasestorage.app",
            messagingSenderId: "229614265706",
            appId: "1:229614265706:web:06c5e2c498baa7f1b5f113"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function extractId(input) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = input.match(regExp);
            return (match && match[7].length === 11) ? match[7] : input.trim();
        }

        function sendSong() {
            let titleInput = document.getElementById('songTitle').value.trim();
            let id = extractId(document.getElementById('ytId').value);

            if (!id || id.length !== 11) return alert("è«‹è²¼ä¸Šæ­£ç¢ºçš„ YouTube ç¶²å€ï¼");

            // å¦‚æœä½¿ç”¨è€…æœ‰å¡«æ­Œåï¼Œç›´æ¥é€å‡ºï¼›æ²’å¡«å‰‡è‡ªå‹•è¾¨è­˜
            if (titleInput) {
                pushToFirebase(titleInput, id);
            } else {
                // è‡ªå‹•å‘ YouTube å–å¾—æ¨™é¡Œ (ä¸éœ€ Key çš„å…¬é–‹ä»‹é¢)
                const fetchUrl = `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`;
                fetch(fetchUrl)
                    .then(res => res.json())
                    .then(data => {
                        const autoTitle = data.title || "æœªçŸ¥æ­Œæ›²";
                        pushToFirebase(autoTitle, id);
                    })
                    .catch(() => {
                        pushToFirebase("æ–°é»æ’­æ­Œæ›²", id);
                    });
            }
        }

        function pushToFirebase(finalTitle, ytId) {
            db.ref('playlist').push({
                title: finalTitle,
                ytId: ytId,
                timestamp: Date.now()
            }).then(() => {
                alert("é»æ­ŒæˆåŠŸï¼");
                document.getElementById('ytId').value = '';
                document.getElementById('songTitle').value = '';
            });
        }
    </script>
</body>
</html>