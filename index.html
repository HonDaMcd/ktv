<body>

<div id="overlay">
    <h1 style="color: #ff0055; font-size: 3rem; margin-bottom: 30px;">🎤 KTV 準備就緒</h1>
    <button class="btn btn-start" onclick="initKTV()">點擊開始新年歌友會</button>
</div>

<div id="main">
    <h1 id="title" style="color: #ff0055; font-size: 2rem; margin-bottom: 10px;">🎤 歡迎點歌</h1>
    
    <div id="player-container">
        <div id="player"></div>
    </div>
    <div style="margin-top: 20px;">
        <button class="btn btn-next" onclick="playNext()">⏭️ 切歌 / 下一首</button>
        <button class="btn btn-next" style="background:#222" onclick="location.reload()">🔄 重新整理系統</button>
    </div>
</div>

<div id="sidebar">
    <h2 style="color: #ff0055;">待播清單</h2>
    <ul id="songList" style="padding: 0;"></ul>
</div>

<script src="https://www.youtube.com/iframe_api"></script> <script>
    // ... 你的 firebaseConfig 保持不變 ...
    const firebaseConfig = {
  apiKey: "AIzaSyB7FxIh0oUu21zTLxnhOttyN_kL0LiYAPw",
  authDomain: "my-karaoke-5b9e3.firebaseapp.com",
  databaseURL: "https://my-karaoke-5b9e3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-karaoke-5b9e3",
  storageBucket: "my-karaoke-5b9e3.firebasestorage.app",
  messagingSenderId: "229614265706",
  appId: "1:229614265706:web:06c5e2c498baa7f1b5f113",
  measurementId: "G-1YVK3HE4VK"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var player;
    var currentSongs = [];
    var playerIsReady = false;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'enablejsapi': 1 },
            events: {
                'onReady': () => { playerIsReady = true; },
                'onStateChange': (e) => {
                    // 自動抓取 YouTube 標題
                    if (e.data == YT.PlayerState.PLAYING) {
                        try {
                            const realTitle = player.getVideoData().title;
                            document.getElementById('title').innerText = "🎤 正在播放：" + realTitle;
                        } catch(err) { console.log("抓不到標題"); }
                    }
                    if (e.data == YT.PlayerState.ENDED) playNext();
                }
            }
        });
    }

    function initKTV() {
        document.getElementById('overlay').style.display = 'none';
        
        // 修正排序：插播的歌（負數 timestamp）會排在最前面
        db.ref('playlist').orderByChild('timestamp').on('value', (snapshot) => {
            const listUI = document.getElementById('songList');
            listUI.innerHTML = '';
            currentSongs = [];

            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                currentSongs.push({ key: childSnapshot.key, ...data });
                
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerText = data.title;
                listUI.appendChild(li);
            });

            // 如果目前沒在播放且清單有歌，自動啟動
            if (playerIsReady && currentSongs.length > 0) {
                const state = player.getPlayerState();
                if (state !== 1 && state !== 3) {
                    player.loadVideoById(currentSongs[0].ytId);
                }
            }
        });
    }

    function playNext() {
        if (currentSongs.length > 0) {
            const finishedSong = currentSongs[0];
            db.ref('playlist/' + finishedSong.key).remove().then(() => {
                // 核心修正：移除後，直接抓取最新的 currentSongs[1] (現在變成新清單的第一首)
                // 這裡 Firebase 的 on('value') 會自動幫我們更新 currentSongs
                console.log("已切歌");
            });
        }
    }
</script>