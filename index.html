<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éå¹´ KTV ç¸½éƒ¨ - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #main { flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #sidebar { flex: 1; background: #111; border-left: 2px solid #333; padding: 20px; overflow-y: auto; }
        #player-container { width: 90%; aspect-ratio: 16/9; background: #222; box-shadow: 0 0 30px rgba(255,0,0,0.2); }
        .song-item { padding: 15px; border-bottom: 1px solid #222; color: #0f0; font-size: 1.2rem; }
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .btn { padding: 15px 30px; font-size: 20px; cursor: pointer; border-radius: 50px; border: none; margin: 10px; }
        .btn-start { background: #ff0055; color: white; }
        .btn-next { background: #444; color: white; }
.song-item { 
    padding: 20px; 
    border-bottom: 2px solid #333; 
    color: #00ff00; 
    font-size: 2rem; /* è®“å­—é«”è®Šè¶…å¤§ */
    font-weight: bold;
}
#sidebar h2 {
    font-size: 2.5rem;
    text-align: center;
}
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color: #ff0055; font-size: 3rem; margin-bottom: 30px;">ğŸ¤ KTV æº–å‚™å°±ç·’</h1>
    <button class="btn btn-start" onclick="initKTV()">é»æ“Šé–‹å§‹æ–°å¹´æ­Œå‹æœƒ</button>
</div>

<div id="main">
    <div id="player-container">
        <div id="player"></div>
    </div>
    <div style="margin-top: 20px;">
        <button class="btn btn-next" onclick="playNext()">â­ï¸ åˆ‡æ­Œ / ä¸‹ä¸€é¦–</button>
        <button class="btn btn-next" style="background:#222" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†ç³»çµ±</button>
    </div>
</div>

<div id="sidebar">
    <h2 style="color: #ff0055;">å¾…æ’­æ¸…å–®</h2>
    <ul id="songList" style="padding: 0;"></ul>
</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7FxIh0oUu21zTLxnhOttyN_kL0LiYAPw",
  authDomain: "my-karaoke-5b9e3.firebaseapp.com",
  databaseURL: "https://my-karaoke-5b9e3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-karaoke-5b9e3",
  storageBucket: "my-karaoke-5b9e3.firebasestorage.app",
  messagingSenderId: "229614265706",
  appId: "1:229614265706:web:06c5e2c498baa7f1b5f113",
  measurementId: "G-1YVK3HE4VK"
};

    // ... ä½ çš„ Firebase Config ä¿æŒä¸è®Š ...
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var player;
    var currentSongs = [];
    var playerIsReady = false;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'enablejsapi': 1 },
            events: {
                'onReady': () => { playerIsReady = true; },
                'onStateChange': (e) => {
                    // ç•¶å½±ç‰‡é–‹å§‹æ’­æ”¾ï¼Œè‡ªå‹•æŠ“å– YouTube æ¨™é¡Œæ›´æ–°åˆ°ç•«é¢ä¸Š
                    if (e.data == YT.PlayerState.PLAYING) {
                        const realTitle = player.getVideoData().title;
                        document.getElementById('title').innerText = "ğŸ¤ æ­£åœ¨æ’­æ”¾ï¼š" + realTitle;
                    }
                    // å½±ç‰‡çµæŸè‡ªå‹•ä¸‹ä¸€é¦–
                    if (e.data == YT.PlayerState.ENDED) playNext();
                }
            }
        });
    }

    function initKTV() {
        document.getElementById('overlay').style.display = 'none';
        
        // ä½¿ç”¨ orderByChild ç¢ºä¿æ’æ’­çš„æ­Œæ’åœ¨å‰é¢
        db.ref('playlist').orderByChild('timestamp').on('value', (snapshot) => {
            const listUI = document.getElementById('songList');
            listUI.innerHTML = '';
            currentSongs = [];

            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                currentSongs.push({ key: childSnapshot.key, ...data });
                
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerText = data.title;
                listUI.appendChild(li);
            });

            // å¦‚æœç›®å‰æ²’åœ¨æ’­ï¼Œè‡ªå‹•å•Ÿå‹•ç¬¬ä¸€é¦–
            if (playerIsReady && currentSongs.length > 0) {
                if (player.getPlayerState() !== 1 && player.getPlayerState() !== 3) {
                    player.loadVideoById(currentSongs[0].ytId);
                }
            }
        });
    }

    function playNext() {
        if (currentSongs.length > 0) {
            const finishedSong = currentSongs[0];
            // åˆªé™¤ç›®å‰é€™é¦–ï¼ŒFirebase æœƒè‡ªå‹•è§¸ç™¼ initKTV è£¡çš„ç›£è½ä¸¦æ’­ä¸‹ä¸€é¦–
            db.ref('playlist/' + finishedSong.key).remove().then(() => {
                if (currentSongs.length > 1) {
                    player.stopVideo();
                    player.loadVideoById(currentSongs[1].ytId);
                } else {
                    player.stopVideo();
                    document.getElementById('title').innerText = "ğŸ¤ æ¸…å–®å·²ç©º";
                }
            });
        }
    }
</script>
</body>
</html>