<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éå¹´ KTV ç¸½éƒ¨ - ç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
        #main { flex: 3; padding: 20px; text-align: center; background: black; }
        #sidebar { flex: 1; background: #252525; padding: 20px; border-left: 1px solid #444; }
        #player { width: 100%; aspect-ratio: 16/9; background: #333; }
        .song-item { padding: 10px; border-bottom: 1px solid #333; list-style: none; color: #ffeb3b; }
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .start-btn { padding: 20px 40px; font-size: 24px; cursor: pointer; background: #e91e63; color: white; border: none; border-radius: 10px; }
    </style>
</head>
<body>

<div id="overlay">
    <button class="start-btn" onclick="startSystem()">é»æ“Šæ­¤è™•å•Ÿå‹• KTV ç³»çµ±</button>
</div>

<div id="main">
    <h1 id="title">ğŸ¤ ç³»çµ±å¾…æ©Ÿä¸­...</h1>
    <div id="player"></div>
    <div style="margin-top: 20px;">
        <button onclick="playNext()" style="padding:10px 20px; font-size:18px;">ä¸‹ä¸€é¦– (åˆ‡æ­Œ)</button>
    </div>
</div>

<div id="sidebar">
    <h3>å¾…æ’­æ¸…å–®</h3>
    <ul id="songList"></ul>
</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7FxIh0oUu21zTLxnhOttyN_kL0LiYAPw",
  authDomain: "my-karaoke-5b9e3.firebaseapp.com",
  databaseURL: "https://my-karaoke-5b9e3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-karaoke-5b9e3",
  storageBucket: "my-karaoke-5b9e3.firebasestorage.app",
  messagingSenderId: "229614265706",
  appId: "1:229614265706:web:06c5e2c498baa7f1b5f113",
  measurementId: "G-1YVK3HE4VK"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var player;
    var currentSongs = [];
    var isPlayerReady = false;

    // è¼‰å…¥ YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            playerVars: { 
                'autoplay': 1, 
                'controls': 1, 
                'rel': 0,
                'origin': window.location.origin 
            },
            events: {
                'onReady': () => { isPlayerReady = true; console.log("æ’­æ”¾å™¨æº–å‚™å¥½äº†ï¼"); },
                'onStateChange': (e) => { if(e.data == 0) playNext(); },
                'onError': (e) => { console.log("YouTube å ±éŒ¯ç¢¼:", e.data); playNext(); }
            }
        });
    }

    function startSystem() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('title').innerText = "ğŸ¤ æˆ‘å€‘çš„å®¶åº­ KTV";
        
        // å•Ÿå‹•ç›£è½
        db.ref('playlist').on('value', (snapshot) => {
            const data = snapshot.val();
            const listUI = document.getElementById('songList');
            listUI.innerHTML = '';
            currentSongs = [];

            if (data) {
                Object.keys(data).forEach(key => {
                    currentSongs.push({ key: key, ...data[key] });
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerText = data[key].title;
                    listUI.appendChild(li);
                });

                // å¦‚æœç›®å‰æ²’åœ¨æ’­ï¼Œå°±å˜—è©¦æ’­ä¸‹ä¸€é¦–
                if (isPlayerReady && player.getPlayerState() !== 1 && player.getPlayerState() !== 3) {
                    playNext();
                }
            }
        });
    }

    function playNext() {
        if (currentSongs.length > 0) {
            const next = currentSongs[0];
            console.log("æ­£åœ¨å˜—è©¦æ’­æ”¾ ID:", next.ytId);
            player.loadVideoById(next.ytId);
            db.ref('playlist/' + next.key).remove();
        }
    }
</script>
</body>
</html>