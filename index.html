<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éå¹´ KTV ç¸½éƒ¨ - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #main { flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #sidebar { flex: 1; background: #111; border-left: 2px solid #333; padding: 20px; overflow-y: auto; }
        #player-container { width: 90%; aspect-ratio: 16/9; background: #222; box-shadow: 0 0 30px rgba(255,0,0,0.2); }
        .song-item { padding: 15px; border-bottom: 1px solid #222; color: #0f0; font-size: 1.2rem; }
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .btn { padding: 15px 30px; font-size: 20px; cursor: pointer; border-radius: 50px; border: none; margin: 10px; }
        .btn-start { background: #ff0055; color: white; }
        .btn-next { background: #444; color: white; }
.song-item { 
    padding: 20px; 
    border-bottom: 2px solid #333; 
    color: #00ff00; 
    font-size: 2rem; /* è®“å­—é«”è®Šè¶…å¤§ */
    font-weight: bold;
}
#sidebar h2 {
    font-size: 2.5rem;
    text-align: center;
}
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color: #ff0055; font-size: 3rem; margin-bottom: 30px;">ğŸ¤ KTV æº–å‚™å°±ç·’</h1>
    <button class="btn btn-start" onclick="initKTV()">é»æ“Šé–‹å§‹æ–°å¹´æ­Œå‹æœƒ</button>
</div>

<div id="main">
    <div id="player-container">
        <div id="player"></div>
    </div>
    <div style="margin-top: 20px;">
        <button class="btn btn-next" onclick="playNext()">â­ï¸ åˆ‡æ­Œ / ä¸‹ä¸€é¦–</button>
        <button class="btn btn-next" style="background:#222" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†ç³»çµ±</button>
    </div>
</div>

<div id="sidebar">
    <h2 style="color: #ff0055;">å¾…æ’­æ¸…å–®</h2>
    <ul id="songList" style="padding: 0;"></ul>
</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7FxIh0oUu21zTLxnhOttyN_kL0LiYAPw",
  authDomain: "my-karaoke-5b9e3.firebaseapp.com",
  databaseURL: "https://my-karaoke-5b9e3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "my-karaoke-5b9e3",
  storageBucket: "my-karaoke-5b9e3.firebasestorage.app",
  messagingSenderId: "229614265706",
  appId: "1:229614265706:web:06c5e2c498baa7f1b5f113",
  measurementId: "G-1YVK3HE4VK"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var player;
    var currentSongs = [];
    var playerIsReady = false;

    // è¼‰å…¥ API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'enablejsapi': 1 },
            events: {
                'onReady': () => { playerIsReady = true; },
                'onStateChange': (e) => { if(e.data == YT.PlayerState.ENDED) playNext(); },
                'onError': (e) => { 
                    console.log("Error:", e.data);
                    // åªæœ‰åœ¨çœŸçš„å‡ºéŒ¯æ™‚æ‰è·³ä¸‹ä¸€é¦–ï¼Œä¸è¦è‡ªå‹•ä¸€ç›´è·³
                }
            }
        });
    }

    function initKTV() {
        document.getElementById('overlay').style.display = 'none';
        
        db.ref('playlist').on('value', (snapshot) => {
            const data = snapshot.val();
            const listUI = document.getElementById('songList');
            listUI.innerHTML = '';
            currentSongs = [];

            if (data) {
                Object.keys(data).forEach(key => {
                    currentSongs.push({ key: key, ...data[key] });
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerText = data[key].title;
                    listUI.appendChild(li);
                });

                // å¦‚æœç›®å‰æ˜¯ç©ºé–’ç‹€æ…‹ï¼Œå˜—è©¦æ’­ç¬¬ä¸€é¦–
                if (playerIsReady && player.getPlayerState() !== 1) {
                    playFirstInQueue();
                }
            }
        });
    }

    function playFirstInQueue() {
        if (currentSongs.length > 0) {
            const next = currentSongs[0];
            player.loadVideoById(next.ytId);
            // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘å…ˆä¸åˆªé™¤è³‡æ–™åº«ï¼Œç­‰çœŸçš„æ’­å®Œäº†æˆ–æŒ‰åˆ‡æ­Œå†åˆª
        }
    }

    function playNext() {
        if (currentSongs.length > 0) {
            // 1. å…ˆæŠŠè¦åˆªé™¤çš„é‚£é¦–æ­Œï¼ˆç›®å‰é€™é¦–ï¼‰ç´€éŒ„ä¸‹ä¾†
            const finishedSong = currentSongs[0];
            
            // 2. å¾è³‡æ–™åº«åˆªé™¤
            db.ref('playlist/' + finishedSong.key).remove().then(() => {
                console.log("å·²å¾è³‡æ–™åº«ç§»é™¤ï¼š" + finishedSong.title);
                
                // 3. æª¢æŸ¥é™£åˆ—è£¡æ˜¯å¦æœ‰ä¸‹ä¸€é¦–æ­Œ (åŸæœ¬çš„ index 1)
                if (currentSongs.length > 1) {
                    const nextVideo = currentSongs[1];
                    console.log("å¼·åˆ¶åˆ‡æ›è‡³ä¸‹ä¸€é¦–ï¼š" + nextVideo.title);
                    
                    // æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶åœæ­¢ç›®å‰çš„ï¼Œç«‹åˆ»è¼‰å…¥æ–°çš„
                    player.stopVideo(); 
                    player.loadVideoById(nextVideo.ytId);
                } else {
                    // å¦‚æœæ²’æ­Œäº†å°±åœæ­¢
                    player.stopVideo();
                    console.log("æ¸…å–®å·²ç©ºï¼Œåœæ­¢æ’­æ”¾");
                }
            });
        }
    }
</script>
</body>
</html>